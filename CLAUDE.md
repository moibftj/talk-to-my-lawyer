# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

**Talk-To-My-Lawyer** is an AI-powered legal letter drafting platform with mandatory attorney review. Letters generated by OpenAI must be approved by attorneys (Super Admin or Attorney Admin) before subscribers can access them.

**Tech Stack:**
- Frontend/SSR: Next.js 16 (App Router), React 19, Tailwind v4 + shadcn/ui (new-york style)
- Backend: Supabase (Postgres + RLS), Stripe, Resend email, Upstash Redis
- AI: OpenAI SDK (`openai` package) with n8n webhook integration
- Package manager: **pnpm only** (version 10.28.0)
- Deployment: Vercel (region `iad1`)

## Development Commands

```bash
# Core development
pnpm dev                  # Start dev server on localhost:3000
pnpm build                # Production build
CI=1 pnpm build           # Strict production build (must pass before merge)
pnpm lint                 # ESLint
pnpm lint:fix             # Auto-fix ESLint issues
pnpm test                 # Run Vitest suite
pnpm test:ui              # Vitest UI mode
pnpm test:run             # Run tests once (non-watch)
pnpm test:coverage        # Coverage report

# Database & environment
pnpm validate-env         # Check required environment variables
pnpm db:migrate           # Apply Supabase SQL migrations
pnpm db:verify            # Verify database connection

# Security & deployment
pnpm security:scan        # Audit for vulnerabilities
pnpm predeploy:check      # Pre-deployment validation
pnpm health-check         # Local health check
pnpm health-check:production  # Production health check
```

## Build Verification

**After every code change, run the strict production build to ensure it passes:**

```bash
CI=1 pnpm build
```

This must succeed before any code is committed or merged. The strict build catches:
- TypeScript errors
- ESLint violations
- Build-time errors
- Unused exports

If the build fails, fix all errors before proceeding.

## Architecture

### Letter Lifecycle Flow

```
draft → generating → pending_review → under_review → approved/rejected/needs_changes → completed
```

Status transitions are enforced by `VALID_LETTER_TRANSITIONS` in `lib/constants/statuses.ts`. Letter generation always routes through `/api/generate-letter` which:
1. Rate limits the request
2. Authenticates user as subscriber
3. Checks/deducts allowance
4. Calls n8n webhook for AI generation
5. Sets status to `pending_review` (attorney must approve)

### Supabase Client Patterns

```typescript
// Server components and API routes (per-request, respects RLS)
import { createClient } from '@/lib/supabase/server'
const supabase = await createClient()

// Client components (singleton)
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()

// Service role (bypasses RLS) - ONLY for system operations
const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY
```

Database types are auto-generated in `lib/database.types.ts`. Import types from `lib/supabase/types.ts` for `DatabaseWithRelationships`.

### API Route Standard Pattern

All API routes follow this structure:

Add `export const runtime = "nodejs"` to routes that need longer timeouts (AI: 60s, cron: 120s, PDF: 30s per `vercel.json` function configs).

```typescript
import { type NextRequest } from "next/server"
import { safeApplyRateLimit } from '@/lib/rate-limit-redis'
import { requireSubscriber, requireAuth } from '@/lib/auth/authenticate-user'
import { successResponse, errorResponses, handleApiError } from '@/lib/api/api-error-handler'

export const runtime = "nodejs"

export async function POST(request: NextRequest) {
  try {
    // 1. Rate limit
    const rateLimitResponse = await safeApplyRateLimit(request, rateLimit, ...config)
    if (rateLimitResponse) return rateLimitResponse

    // 2. Auth
    const { user, supabase } = await requireSubscriber() // or requireAuth() for any user

    // 3. Validate input
    const body = await request.json()
    // ... validation logic

    // 4. Business logic
    // ... operations

    // 5. Response
    return successResponse({ data }, 200)
  } catch (error) {
    return handleApiError(error, 'context-name')
  }
}
```

Use custom error classes from `lib/api/api-error-handler.ts`:
- `AuthenticationError` (401)
- `AuthorizationError` (403)
- `ValidationError` (400)
- `NotFoundError` (404)
- `RateLimitError` (429)
- `ExternalServiceError` (502)

### Authentication & Authorization

All auth helpers are in `lib/auth/authenticate-user.ts` and return `{ user, supabase }` or throw an appropriate error class:

- `requireSubscriber()` - allows subscriber role (and above)
- `requireAuth()` - any authenticated user
- `requireAdmin()` - admin/super_admin only
- `requireEmployee()` - employee role only

**Admin portal routes:** `requireAdminSession(request)` - uses JWT-signed cookies, valid for 30 minutes. Returns `AdminSession` with `subRole` (`'super_admin'` | `'attorney_admin'`)

**Role checks happen at API route level, not middleware.** Employees (`role = 'employee'`) must never see letter content - enforce in both API and UI.

### Environment Variables

Access via `lib/config/env.ts` for type-safe configs:
```typescript
import { supabase, openai, stripe, app } from '@/lib/config/env'

const url = supabase.url
const apiKey = openai.apiKey
const appUrl = app.url  // Falls back through: NEXT_PUBLIC_APP_URL → NEXT_PUBLIC_SITE_URL → VERCEL_URL → default
```

For direct access (e.g., in API routes), use `process.env.VAR_NAME`. Always add new env vars to both `.env.local` and Vercel Dashboard.

**Critical env vars:**
- `NEXT_PUBLIC_SUPABASE_URL` - Now using custom domain: `https://app.talk-to-my-lawyer.com`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `OPENAI_API_KEY`
- `STRIPE_SECRET_KEY`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`
- `RESEND_API_KEY`, `EMAIL_FROM`
- `ADMIN_PORTAL_KEY`
- `CRON_SECRET`

### Cron Jobs (Vercel)

Configured in `vercel.json`:
- `/api/email/process-queue` - Every 5 minutes
- `/api/cron/cleanup-expired-sessions` - Every 6 hours
- `/api/cron/health-check` - Every 30 minutes
- `/api/cron/daily-analytics` - Daily at 1 AM
- `/api/cron/weekly-cleanup` - Weekly on Sunday 2 AM
- `/api/subscriptions/reset-monthly` - Monthly on 1st
- `/api/cron/check-stuck-letters` - Every 2 hours

All cron routes are protected by `CRON_SECRET` header (`Authorization: Bearer ${CRON_SECRET}`).

### Middleware & Route Protection

`middleware.ts` runs on every request (excluding static assets). It:
1. Refreshes Supabase session via `updateSession()` from `lib/supabase/proxy.ts`
2. Reads `role` and `admin_sub_role` from the profiles table
3. Redirects unauthenticated users to login
4. Redirects users to role-appropriate portals:
   - Subscribers → `/dashboard/letters`
   - Employees → `/dashboard/commissions` (never to letters)
   - Attorney admins → `/attorney-portal/review`
   - Super admins → `/secure-admin-gateway/dashboard`
5. Blocks cross-portal access (attorney admin accessing super admin portal is redirected back)

Role enforcement at middleware level handles **redirects only**. API-level `requireSubscriber()` / `requireAdmin()` handle **authorization**.

### Services

`lib/services/` contains reusable business logic called from API routes:

| Service | Purpose |
|---------|---------|
| `letter-generation-service.ts` | Orchestrates AI letter generation end-to-end |
| `n8n-webhook-service.ts` | Calls n8n webhook which invokes OpenAI |
| `allowance-service.ts` | Checks/deducts subscription letter credits |
| `audit-service.ts` | Logs all letter status changes with full trail |
| `notification-service.ts` | Sends admin alerts for new letters / status changes |

### Component Patterns

- **Pages** are server components (async, fetch data with server Supabase client)
- **Layouts and interactive shells** (e.g., `components/dashboard-layout.tsx`) are `'use client'`
- Use `@/` path alias: `import { Button } from '@/components/ui/button'`
- Add shadcn components: `pnpm dlx shadcn@latest add <component>`
- Use design tokens from `lib/design-tokens.ts` for colors instead of hardcoding Tailwind classes

### Email System

Two types of emails:
1. **Auth emails** (confirmations, password reset) - handled by Supabase Auth SMTP
2. **App emails** (notifications, letter status changes) - Resend + queue system

Use `queueTemplateEmail()` from `lib/email` for app emails. It tries immediate send, falls back to queue with retry.

Debug email issues:
1. Run `node check-email-config.js`
2. Run `node test-email-send.js`
3. Check `email_queue` table for failed/sending emails
4. Verify Resend dashboard

See `lib/email/AGENTS.md` for detailed debugging protocol.

### OpenTelemetry Tracing

Business spans are created with `lib/monitoring/tracing.ts`:
```typescript
import { createBusinessSpan, addSpanAttributes, recordSpanEvent } from '@/lib/monitoring/tracing'

const span = createBusinessSpan('operation_name', { 'key': 'value' })
addSpanAttributes({ 'user.id': userId })
recordSpanEvent('step_completed')
span.setStatus({ code: 1, message: 'Success' })
```

## Key Conventions

- **Never disable Supabase RLS** - all user-facing queries go through RLS-enabled clients
- **Never log secrets or PII** - prompts and AI outputs stored for audit in DB, not console
- **Employees must never see letter content** - enforce at both API and UI layers
- **Letter approval requires attorney review** - no auto-approval paths exist
- **Use constants** - `LETTER_STATUSES`, `USER_ROLES` from `lib/types/api.ts`, no magic strings
- **Use pnpm only** - no npm/yarn lockfiles allowed
- **Type safety** - `lib/database.types.ts` is auto-generated, use for DB queries
- **Error handling** - use shared `handleApiError()` and custom error classes

## Testing

- Tests use Vitest with happy-dom
- Test files: `**/*.test.ts` or `**/__tests__/*.ts`
- Run single test: `pnpm test -- <pattern>`
- Environment variables for tests are set in `vitest.setup.ts`

## Important Files

| Purpose | File |
|---------|------|
| Status constants & transitions | `lib/constants/statuses.ts` |
| API error handling | `lib/api/api-error-handler.ts` |
| Auth functions | `lib/auth/authenticate-user.ts`, `lib/auth/admin-session.ts` |
| Environment config | `lib/config/env.ts` |
| Rate limiting | `lib/rate-limit-redis.ts` |
| Letter validation | `lib/validation/letter-schema.ts` |
| Design tokens | `lib/design-tokens.ts` |
| Email service | `lib/email/service.ts` |
| Tracing | `lib/monitoring/tracing.ts` |
| Admin portal login | `app/secure-admin-gateway/login/page.tsx` |
| Letter generation API | `app/api/generate-letter/route.ts` |
| Vercel config | `vercel.json` |

## Admin Roles

- **Super Admin** - Full platform access, can review/approve letters
- **Attorney Admin** - Access to Letter Review Center, can edit/approve/reject letters
- **Employee** - Coupons, commissions, customer support (never sees letter content)
- **Subscriber** - Generates letters, views own history

Admin sub-roles are stored as `admin_sub_role` enum on profiles table. Admin sessions use JWT-signed cookies with 30-minute expiry.
