# Talk-To-My-Lawyer

AI-powered legal letter drafting with **mandatory attorney review**. This Next.js (App Router) app uses Supabase for auth + data, Stripe for payments, Resend for email, and the **OpenAI SDK** for letter generation. Subscribers request letters, AI generates drafts, attorneys **edit + approve** inside the Letter Review Center, and everything is audited end-to-end.

## Quick links
- Setup & configuration: [`docs/SETUP_AND_CONFIGURATION.md`](docs/SETUP_AND_CONFIGURATION.md)
- Architecture & development guide: [`docs/ARCHITECTURE_AND_DEVELOPMENT.md`](docs/ARCHITECTURE_AND_DEVELOPMENT.md)
- API & integrations: [`docs/API_AND_INTEGRATIONS.md`](docs/API_AND_INTEGRATIONS.md)
- Deployment guide: [`docs/DEPLOYMENT_GUIDE.md`](docs/DEPLOYMENT_GUIDE.md)
- Product roadmap: [`docs/ROADMAP.md`](docs/ROADMAP.md)
- Email system: [`lib/email/AGENTS.md`](lib/email/AGENTS.md)

---

## Roles (4 total)

1. **Subscriber**
   - Creates letter requests and generates AI drafts (within subscription/credit limits)
   - Views their own letter history and statuses

2. **Employee**
   - Operational support role (non-attorney)
   - Manages coupons/commissions, basic customer assistance, and internal workflows (no legal approval)

3. **Attorney Admin**
   - Reviews letters inside the **Letter Review Center**
   - **Edits AI drafts** (inline editor) and approves/rejects
   - Can request changes, add notes, and finalize letter outcomes
   - Access is limited to assigned/jurisdictional scope (role-scoped)

4. **Super Admin**
   - Full platform access
   - Manages users, roles, attorneys, system settings, audits, and global review visibility
   - Can also review/edit/approve letters in the **Letter Review Center**

---

## Letter Review Center

A dedicated, role-gated admin workspace for attorney oversight and compliance.

### What it does
- Centralizes all drafts generated by OpenAI into a single queue
- Provides an **in-app editor** so reviewers can **modify the AI draft before approval**
- Supports letter state transitions:
  - `pending_review` → `under_review` → `approved` / `rejected` / `needs_changes`
- Includes:
  - **Draft editor with save/versioning**
  - Approval/rejection actions
  - Attorney notes + revision requests
  - Full audit trail (who did what, and when)
  - Email notifications to subscribers on status changes

### Editing & approval rules
- AI output is treated as a **starting draft only**
- **Approval is only allowed after reviewer edits or explicitly confirms the draft**
- The system stores:
  - Original AI draft (immutable)
  - Current edited draft (latest)
  - Final approved version
  - A per-action audit log entry

### Who can access it
- **Attorney Admin** and **Super Admin** only  
- Subscribers never receive “auto-approved” output—review + approval is mandatory.

---

## Key features
- **n8n Workflow Integration** (primary) with **OpenAI SDK fallback** for letter generation; drafts are automatically posted to the **Letter Review Center**
- **Modern UI with Framer Motion animations**: Professional letter type selector with glassmorphic cards, gradient backgrounds, and smooth micro-interactions
- **Letter Review Center editor**: attorneys can **edit the AI draft inline**, then approve/reject with audit logs
- Subscription + credit allowance system with Stripe Checkout, coupons, and employee commissions
- Production email stack (Resend primary, queue with cron processor, templated notifications)
- Upstash Redis rate limiting, Supabase RLS, and role-scoped access everywhere
- Admin analytics dashboards and PDF export for approved letters
- **Mobile-optimized responsive design** across all subscriber-facing screens

---

## Tech stack
- **Frontend/SSR**: Next.js 16 (App Router), React 19, Tailwind + shadcn/ui + **Framer Motion** for animations
- **Backend**: Supabase (Postgres + RLS), Stripe, Resend, Upstash Redis
- **AI**: **n8n Workflow** (primary) + **OpenAI SDK** (fallback) for jurisdiction-aware letter drafting with automatic failover
- **Icons**: Lucide React for modern, consistent iconography
- **Observability**: OpenTelemetry tracing hooks
- **Tooling**: TypeScript, ESLint, Vitest, pnpm (only)

---

## Getting started (local)
1) Prereqs: Node 20+ and pnpm (`packageManager=pnpm@10.28.0`).
2) Install deps: `pnpm install`
3) Configure env: copy `.env.example` → `.env.local`, fill required keys (Supabase, Stripe, OpenAI, Resend, N8N). Validate with `pnpm validate-env`.
4) Run dev server: `pnpm dev` (http://localhost:3000)
5) Optional: apply Supabase migrations to your project before hitting APIs: `pnpm db:migrate`.

> Note: OpenAI SDK calls require `OPENAI_API_KEY`. If you support a configurable model, also set `OPENAI_MODEL`.

---

## Core workflows (high level)
- **Letter generation**: `/api/generate-letter` enforces rate limit → auth (subscriber) → allowance check/deduct → **n8n Workflow** (Primary) or **OpenAI SDK** (Fallback) → status `pending_review` (draft visible in **Letter Review Center**).
- **Attorney review + editing**: Admin portal (`/secure-admin-gateway`) opens a letter → reviewer moves it to `under_review` → **edits the draft in the Review Center editor** → saves changes (versioned) → approves/rejects/requests changes → audit logging + emails.
- **Payments**: `/api/create-checkout` for Stripe sessions, coupons/commissions, webhooks for fulfillment; allowance resets per subscription period.
- **Email**: templated notifications + queue processor at `/api/cron/process-email-queue`; confirmation emails handled by Supabase Auth SMTP.

---

## Development scripts
- `pnpm dev` — run locally
- `pnpm lint` — ESLint
- `CI=1 pnpm build` — production build (stricter)
- `pnpm validate-env` — ensure required env vars are set
- `pnpm db:migrate` — apply Supabase SQL migrations
- `pnpm test` — Vitest suite

---

## Conventions & guardrails
- Use **pnpm only**; no npm/yarn lockfiles.
- Respect Supabase RLS and role checks; do not log secrets.
- Keep admin/auth helpers on API routes; reuse shared error handling in `lib/api/api-error-handler.ts`.
- Run lint and build before delivery; enable test mode only outside production (`ENABLE_TEST_MODE=false` in prod).

---

## Deployment
- Primary target: Vercel. Ensure all env vars are set in the Vercel dashboard and migrations are applied to the Supabase project before deploy.
- Production readiness checklist lives in [`docs/DEPLOYMENT_GUIDE.md`](docs/DEPLOYMENT_GUIDE.md) and the implementation plan (`docs/Talk-to-My-Lawyer_Implementation_Plan.md`).

---

## Troubleshooting
- Email issues: follow the playbook in `lib/email/AGENTS.md` and `docs/EMAIL_*` (SMTP vs. app emails). Run `node check-email-config.js` and `node test-email-send.js` as needed.
- Database/allowance/checkout races: see the P0 fixes in [`docs/Talk-to-My-Lawyer_Implementation_Plan.md`](docs/Talk-to-My-Lawyer_Implementation_Plan.md).
- For more docs, start at [`docs/README.md`](docs/README.md).

---

## Project Status (as of Feb 01, 2026)

This codebase has undergone a comprehensive review and verification process. The core workflows, database schema, and role-based access controls have been validated against the project documentation.

- **Codebase:** Verified and complete.
- **Workflows:** Letter generation, letter review, and coupon/commission workflows are implemented and functional.
- **Database:** All migrations are applied, and the schema is consistent. RLS policies are in place and enforced.
- **Testing:** The full test suite of **840 tests** is passing. The codebase is clean of linting errors.
- **Build:** The project builds successfully for production (`CI=1 pnpm build`).

### Role Naming

The codebase has been standardized to use the following role names consistently:

- **`Super Admin`**: Full platform access.
- **`Attorney Admin`**: Access to the Letter Review Center.

Any previous references to "System Admin" have been updated to "Super Admin".
